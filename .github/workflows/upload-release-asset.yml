on:
  push:
    branches:
      - testpipeline

name: Upload Shopware 6 Marketplace asset

jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      # Step 1: Fetch the newest Shopware version from Dockware
      - name: Fetch Newest Shopware Version
        id: fetch-newest-version
        run: |
          newest_tag=$(curl -s "https://hub.docker.com/v2/repositories/dockware/play/tags?page_size=100" | \
            jq -r '.results[].name' | \
            grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$' | \
            sort -V | \
            tail -n 1)
          echo "NEWEST_DOCKWARE_TAG=$newest_tag" >> $GITHUB_ENV
          echo "Newest Shopware tag is: $newest_tag"

      # Step 2: Create Dynamic Matrix
      - name: Create Dynamic Matrix
        id: set-matrix
        run: |
          echo "Creating dynamic matrix..."
          matrix_json=$(jq -c -n \
            --arg shopware_v1 "6.4.0.0" \
            --arg shopware_v2 "$NEWEST_DOCKWARE_TAG" \
            '{
              include: [
                {shopware_version: $shopware_v1},
                {shopware_version: $shopware_v2}
              ]
            }')
           echo "matrix=$matrix_json" >> $GITHUB_OUTPUT
           echo "Generated matrix: $matrix_json"
        env:
          NEWEST_DOCKWARE_TAG: ${{ env.NEWEST_DOCKWARE_TAG }}

  build-plugin:
    needs: prepare-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
    steps:
      # Step 3: Checkout repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Step 6: Test if set-output replacement is working
      - name: Debug matrix output
        run: |
          echo "Shopware version from matrix is: ${{ matrix.shopware_version }}"